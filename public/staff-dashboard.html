<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stato Tavoli Live</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f7f7f7; }
    h1 { margin-top: 0; }
    #sessions { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .card { padding: 12px; border-radius: 10px; color: #111; background: #fff; border: 2px solid transparent; }
    .open { border-color: #ff9800; background: #fff3e0; }
    .closed { border-color: #2e7d32; background: #e8f5e9; }
    .muted { color: #555; font-size: 0.95rem; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Stato Tavoli Live</h1>
  <p class="muted">Aggiornamento automatico ogni 5 secondi.</p>
  <div id="sessions"></div>

  <script>
    const previousSessionStatusById = new Map();

    function playTableClosedSound() {
      try {
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        if (!AudioContextClass) return;
        const audioContext = new AudioContextClass();
        const oscillator = audioContext.createOscillator();
        const gain = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = 880;
        gain.gain.value = 0.04;
        oscillator.connect(gain);
        gain.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.12);
      } catch (error) {}
    }

    function escapeHtml(value) {
      return String(value)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    async function loadTables() {
      const container = document.getElementById('sessions');
      try {
        const response = await fetch('/.netlify/functions/get-table-sessions');
        if (!response.ok) throw new Error('Errore caricamento');
        const sessions = await response.json();
        const currentSessionIds = new Set();

        sessions.forEach((session) => {
          const sessionId = String(session.id);
          const currentStatus = session.status;
          const previousStatus = previousSessionStatusById.get(sessionId);
          if (previousStatus === 'open' && currentStatus === 'closed') {
            playTableClosedSound();
          }
          previousSessionStatusById.set(sessionId, currentStatus);
          currentSessionIds.add(sessionId);
        });

        const staleSessionIds = [];
        previousSessionStatusById.forEach((status, sessionId) => {
          if (!currentSessionIds.has(sessionId)) {
            staleSessionIds.push(sessionId);
          }
        });
        staleSessionIds.forEach((sessionId) => previousSessionStatusById.delete(sessionId));

        container.innerHTML = sessions.map((session) => {
          const tableId = Number(session.table_id);
          const total = Number(session.total_cents) || 0;
          const paid = Number(session.paid_cents) || 0;
          const residual = Number(session.residual_cents) || 0;
          return `
          <div class="card ${session.status === 'open' ? 'open' : 'closed'}">
            <strong>Tavolo ${escapeHtml(session.table_id)}</strong><br>
            Sessione: ${escapeHtml(session.id)}<br>
             Totale: â‚¬ ${(total / 100).toFixed(2)}<br>
             Pagato: â‚¬ ${(paid / 100).toFixed(2)}<br>
             Residuo: <strong>â‚¬ ${(residual / 100).toFixed(2)}</strong><br>
             Stato: <strong>${escapeHtml(session.status)}</strong>
             ${session.status === 'closed' && Number.isInteger(tableId) && tableId > 0 ? `<br><button type="button" onclick="openSession(${tableId})">Riapri tavolo</button>` : ''}
           </div>
         `;
        }).join('');
      } catch (error) {
        container.innerHTML = '<p>Impossibile caricare i dati tavoli.</p>';
      }
    }

    async function openSession(table_id) {
      try {
        const response = await fetch('/.netlify/functions/open-table-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table_id })
        });
        if (!response.ok) throw new Error('open-session-failed');
        loadTables();
      } catch (error) {
        alert('Impossibile riaprire il tavolo.');
      }
    }

    loadTables();
    setInterval(loadTables, 5000);
  </script>
</body>
</html>
